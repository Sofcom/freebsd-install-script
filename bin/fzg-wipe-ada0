#!/bin/sh

# remove ada0, reinstall on ada0
# add ada1 to ada0 mirror

POOL=$1
NEWHOSTNAME=$2
DISK=$3
DISKTWO=$4
STEP=$5

if [ "x" = "x$POOL" ]; then
    cat <<EOF
Usage:
    $0 pool newhostname ada0 ada1
EOF
    exit 1
fi



if [ "x" = "x$STEP" ]; then
    glabel status | grep ${DISK} | awk '{print $1}' \
    | while read line ; do
    test -e /dev/${line}.eli && zpool detach $POOL ${line}.eli && geli detach ${line}.eli
    test -e /dev/${line}.eli && zpool detach tank ${line}.eli && geli detach ${line}.eli
    test -e /dev/${line}.eli && swapoff /dev/${line}.eli
    test -e /dev/${line} && zpool detach boot$POOL ${line}
    done
    gpart destroy -F ${DISK}
    if [ "pool" = "$POOL" ]; then
        fzg -d ${DISK} -z 2g -n -H usb.local -p usb
    elif [ "usb" = "$POOL" ]; then
        fzg -d ${DISK} -z 2g -n -H $NEWHOSTNAME
    fi
    copy-network-conf-to-mnt
    cat <<EOF
Please reboot then run:
    $0 - - ${DISK} ${DISKTWO} 2
EOF
elif [ "x2" = "x$STEP" ]; then
    env SQUID=${SQUID} first-run -q
    gpart destroy -F ${DISKTWO}
    if zpool status usb >/dev/null 2>/dev/null ; then
        fzg -e ${DISK} -z 2g -d ${DISKTWO} -p usb
    elif zpool status pool >/dev/null 2>/dev/null ; then
        fzg -e ${DISK} -z 2g -d ${DISKTWO} -p pool
    fi
    env SQUID=${SQUID} first-run
fi
