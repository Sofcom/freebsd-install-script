#!/bin/sh
######################################################################
# LICENSE pulled in with, cat LICENSE  | awk '{print "# "$0}'
######################################################################
# Portions of code modified from the compilation of software known
# as mfsBSD: Copyright (C) 2007-2013 Martin Matuska
#
# They are noted in code comments as beind borrowed of modified
# from https://github.com/mmatuska/mfsbsd
#
# The rest of the code: Copyright (c) 2014-2015, John Ko
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# * Redistributions of source code must retain the above copyright notice, this
#   list of conditions and the following disclaimer.
#
# * Redistributions in binary form must reproduce the above copyright notice,
#   this list of conditions and the following disclaimer in the documentation
#   and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
######################################################################
# Script version is yymmdd-HHMMSS in UTC, date +%y%m%d-%H%M%S
######################################################################
SCRIPTVERSION=150409-024250

### Variables you can edit

ZFSBOOT_BEROOT_NAME=rfs
ZFSBOOT_BOOTFS_NAME=default
ZFSBOOT_BOOT_POOL_SIZE=2g
BSDINSTALL_DISTSITE_BASE="http://ftp.freebsd.org/pub/FreeBSD/releases"
ZFSBOOT_GELI_KEY_FILE=/boot/encryption.key
FZG_RELEASE=10.1-RELEASE
ZFSBOOT_SWAP_SIZE=2g

### Variables you don't touch

FZG_ALIGN4K="-a 4k"
ZFSBOOT_BOOT_POOL_NAME=bootpool
FZG_BSDINSTALL_TMP=/tmp/bsdinstall_boot
FZG_BSDINSTALL_ETC=/tmp/bsdinstall_etc
FZG_TMP_CRYPT=/tmp/crypt
FZG_DATA_CRYPT_KEY=/boot/data.crypt.key
FZG_DATA_SIZES="3730 3620 2800 2690 1860 1740 940 830" # Preferred descending order
FZG_MFS_MNT=/mnt2
FZG_MFSROOT=mfsroot
ntpdate_hosts="pool.ntp.org"
FZG_CHANGE_PASSWD=y
ZFSBOOT_VDEV_TYPE=stripe
FZG_RESTORE_UMASK=`umask`

######################################################################
# Start of functions
######################################################################

### Usage
usage() {
    cat <<EOF
usage:  ${0##*/} -d disk [-d disk ...] [-e disk]
        [-b boot_size] [-h] [-m] [-M /mnt] [-p poolname]
        [-r stripe|mirror|raidz|raidz2|raidz3] [-s swap_size] [-v]
        [-z pool_size]

        -b size     Boot partition size.
        -c          Configure sshd_config, loader.conf and rc.conf, rc.conf.d.
        -C          Same as -c plus loader.conf.local and rc.conf.local.
        -d disk     Disk to install on (eg. da0).
        -e disk     Attach to this existing disk that is part of -p pool.
        -h          Help.
        -m          Create mfsroot type of system.
        -M mount    Mountpoint, if not using /mnt.
        -n          Don't prompt to change password.
        -p name     ZFS pool name, must be unique.
        -r          Select ZFS raid mode if multiple -d given.
        -s size     Swap partition size.
        -v          Version.
        -z size     ZFS pool size.

        ${0##*/} -f [-n] [-p poolname]

        -f          freebsd-update / make a new mfsroot.

        ${0##*/} -i -d vdev [-d vdev ...] [-p poolname] [-x]
        ${0##*/} -i -e vdev -d vdev [-p poolname]
        ${0##*/} -u -d vdev [-d vdev ...] [-p poolname]
        ${0##*/} -l [-p poolname]

        -i          Initialize data partition with geli and create pool.
                    Automatically create partition 5 unless -x is set.
        -l          Export pool and lock data partition.
        -u          Unlock data partition and mount pool.
        -x          Explicit -d device, don't create partition 5 automatically.
        -d vdev     Virtual device to grab gptid label from (eg. da0p5)

typical usage:

    Install on mirror, make /bootpool/mfsroot
        ${0##*/} -d ada0 -d ada1 -z 2g -m
    Update /bootpool/mfsroot, reboot to take effect
        ${0##*/} -f
        reboot
    Create /tank
        ${0##*/} -i
    Unlock /tank
        ${0##*/} -u
    Unmount and lock /tank
        ${0##*/} -l

examples:

    Install on disk 0, pool name mini with size 2 GB:
        ${0##*/} -d ada0 -z 2g -p mini
    Add disk 1 as mirror to existing pool mini that contains disk ada0:
        ${0##*/} -e ada0 -d ada1 -z 2g -p mini
    After rebooting again, add data partition automatically + create pool tank:
        ${0##*/} -i -d ada0 -p tank
    Create another data partition and attach to pool tank:
        ${0##*/} -i -e ada0p5 -d ada1 -p tank

other examples:

    Install on 3 mirror disks, a boot pool 1 GB, swap 1 GB, ZFS root pool 2 GB:
        ${0##*/} -d ada0 -d ada1 -d ada2 -b 1g -s 1g -z 2g -r mirror
    Make a bootable ZFS USB, which loads as mfs:
    Note we change the pool name so they don't conflict.
        ${0##*/} -d da0 -m -p usb
    Minimal mirror mfs server:
        ${0##*/} -d ada0 -d ada1 -z 2g -m -p mini
    After rebooting into the new mfsroot system, it can be updated with:
        ${0##*/} -f -p mini
    Create data pool with these devices, no auto partition creation:
        ${0##*/} -i -d ada0p5 -d ada1p5 -p data -x
EOF
}



### append motd function
append_motd() {
    if ! grep "stat-all" ${1}/etc/motd >/dev/null 2>&1 ; then
        cat >>${1}/etc/motd <<EOF

    Update programs and scripts:            fres
    Cache program packages for reboot:      fres -b
    System information:                     stat-all
    Hard drive information:                 hddid
    zpool status + geli translation:        zss
EOF
        if [ -e /boot/../mfsroot ]; then
            cat >>${1}/etc/motd <<EOF
    Update operating system mfsroot:        fzg -f [-n] [-p pool]
                                            reboot
    Update operating system leftovers:      freebsd-update fetch
                                            freebst-update install
                                            reboot
EOF
        else
            cat >>${1}/etc/motd <<EOF
    Update operating system:                freebsd-update fetch
                                            freebsd-update install
                                            reboot
EOF
        fi
            cat >>${1}/etc/motd <<EOF
    PF firewall, block ssh spammers:        pf-sshinvaliduserip
                blacklist sshban list:      pf-move-sshban-to-black
                show tables:                pf-table show all
                show anchor:                pf-anchor show all
EOF
    fi
}



### Exit function
exiterror() {
    [ "$1" != "0" ] && echo "ERROR: code $1 when trying to run: $2"
    umount ${FZG_TMP_CRYPT} >/dev/null 2>&1
    umount ${FZG_BSDINSTALL_TMP} >/dev/null 2>&1
    exit $1
}



### Decrypt function
cryptdecode() {
    umask 077
    install -d -m 700 -o root -g wheel ${FZG_TMP_CRYPT}
    chown root:wheel ${FZG_TMP_CRYPT}
    chmod 700 ${FZG_TMP_CRYPT}
    umount ${FZG_TMP_CRYPT} >/dev/null 2>&1
    mount -t tmpfs tmpfs ${FZG_TMP_CRYPT}
    TMPFILE=`mktemp ${FZG_TMP_CRYPT}/crypt.XXXXXX`
    echo -n "Decrypting Password, "
    openssl enc -aes-256-cbc -in ${FZG_DATA_CRYPT_KEY} -out ${TMPFILE} -d -salt || rm ${TMPFILE}
    umask $FZG_RESTORE_UMASK
}



### Post-install configuration
freebsdconfigglobal() {
    ### Set some loader.conf options global to vps hosts too
    sysrc -f "${FZG_MNT}/boot/loader.conf" autoboot_delay="1" >/dev/null
    ### hw.usb.no_shutdown_wait allows USB not to stall poweroff
    sysrc -f "${FZG_MNT}/boot/loader.conf" "hw.usb.no_shutdown_wait=1" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf" "kern.cam.boot_delay=10000" >/dev/null
    ### I prefer no disk ID
    sysrc -f "${FZG_MNT}/boot/loader.conf" "kern.geom.label.disk_ident.enable=0" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf" "kern.geom.label.gpt.enable=0" >/dev/null
    ### But I allow UUID
    sysrc -f "${FZG_MNT}/boot/loader.conf" "kern.geom.label.gptid.enable=1" >/dev/null
    ### Kernel max
    sysrc -f "${FZG_MNT}/boot/loader.conf" "kern.maxfiles=65530" >/dev/null
    ### loader_logo should stop logo from showing, appears to be BROKEN
    sysrc -f "${FZG_MNT}/boot/loader.conf" loader_logo="none" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf" nullfs_load="YES" >/dev/null
    ### tmpfs_load for mfsroot /usr
    sysrc -f "${FZG_MNT}/boot/loader.conf" tmpfs_load="YES" >/dev/null
    ### virtual if using emulators/virtio-kmod
    echo "# if_vtnet_load=\"YES\"" >>"${FZG_MNT}/boot/loader.conf"
    echo "# virtio_load=\"YES\"" >>"${FZG_MNT}/boot/loader.conf"
    echo "# virtio_pci_load=\"YES\"" >>"${FZG_MNT}/boot/loader.conf"
    echo "# virtio_blk_load=\"YES\"" >>"${FZG_MNT}/boot/loader.conf"
    echo "# virtio_balloon_load=\"YES\"" >>"${FZG_MNT}/boot/loader.conf"

    ### Set some rc.conf options
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/abi" linux_enable="YES" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/auditd" auditd_enable="YES" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/ezjail" ezjail_enable="YES" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/ftp-proxy" ftpproxy_enable="YES" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/ntpdate" ntpdate_enable="YES" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/ntpdate" ntpdate_hosts="$ntpdate_hosts" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/openntpd" openntpd_enable="YES" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/pf" pf_enable="YES" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/pf" pf_rules="/etc/pf/pf.conf" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/pflog" pflog_enable="YES" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/pflog" pflog_logfile="/var/log/pflog" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/random" entropy_file="/var/db/entropy-file" >/dev/null
    echo "# sendmail_enable=\"NO\"" >>"${FZG_MNT}/etc/rc.conf.d/sendmail"
    echo "# sendmail_submit_enable=\"NO\"" >>"${FZG_MNT}/etc/rc.conf.d/sendmail"
    echo "# sendmail_outbound_enable=\"NO\"" >>"${FZG_MNT}/etc/rc.conf.d/sendmail"
    echo "# sendmail_msp_queue_enable=\"NO\"" >>"${FZG_MNT}/etc/rc.conf.d/sendmail"
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/sshd" sshd_enable="YES" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/sshd" sshd_rsa1_enable="NO" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/sshd" sshd_dsa_enable="NO" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/sshd" sshd_ecdsa_enable="NO" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/syslogd" syslogd_flags="-s -b127.0.0.1" >/dev/null
    sysrc -f "${FZG_MNT}/etc/rc.conf.local" zfs_enable="YES" >/dev/null
    ### Set SSH options
    grep      '^ChallengeResponseAuthentication no'  "${FZG_MNT}/etc/ssh/sshd_config" \
        || echo ChallengeResponseAuthentication no >>"${FZG_MNT}/etc/ssh/sshd_config"
    grep      '^PermitRootLogin yes'  "${FZG_MNT}/etc/ssh/sshd_config" \
        || echo PermitRootLogin yes >>"${FZG_MNT}/etc/ssh/sshd_config"
    grep      '^UseDNS no'  "${FZG_MNT}/etc/ssh/sshd_config" \
        || echo UseDNS no >>"${FZG_MNT}/etc/ssh/sshd_config"
    grep      '^ClientAliveInterval 5' "${FZG_MNT}/etc/ssh/sshd_config" \
        || echo ClientAliveInterval 5 >>"${FZG_MNT}/etc/ssh/sshd_config"
    ### SSHD Hardening
    grep      '^KexAlgorithms' "${FZG_MNT}/etc/ssh/sshd_config" \
        || echo KexAlgorithms `ssh -Q kex | grep -v diffie-hellman-group1-sha1 | grep -v ecdh-sha2-nistp | grep -v sha1 | sort | tr '\n' ',' | sed 's/,$//'` >>"${FZG_MNT}/etc/ssh/sshd_config"
    grep      '^Ciphers' "${FZG_MNT}/etc/ssh/sshd_config" \
        || echo Ciphers `ssh -Q cipher | grep -v 3des | grep -v arcfour | grep -v cast | grep -v cbc | grep -v ctr | sort -r \
          | tr '\n' ','``ssh -Q cipher | grep -v 3des | grep -v arcfour | grep -v cast | grep -v cbc | grep    ctr | sort -r | tr '\n' ',' | sed 's/,$//'` >>"${FZG_MNT}/etc/ssh/sshd_config"
    grep      '^MACs' "${FZG_MNT}/etc/ssh/sshd_config" \
        || echo MACs  `ssh -Q mac | grep -v sha1 | grep -v md5 | grep -v '\-64' | grep etm | grep -v umac | sort -r \
        | tr '\n' ','``ssh -Q mac | grep -v sha1 | grep -v md5 | grep -v '\-64' | grep etm | grep     umac | sort -r | tr '\n' ',' | sed 's/,$//'` >>"${FZG_MNT}/etc/ssh/sshd_config"
    grep '^HostKey' "${FZG_MNT}/etc/ssh/sshd_config" \
        || cat    >>"${FZG_MNT}/etc/ssh/sshd_config" <<EOF
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ed25519_key
EOF
}



freebsdconfiglocal() {
    ### .local specific to this machine
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" aesni_load="YES" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" ahci_load="YES" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" aio_load="YES" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" geom_eli_load="YES" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" geom_label_load="YES" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" geom_mirror_load="YES" >/dev/null
    ### hw.bge.allow_asf for my HP server to stop network disconnect
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" "hw.bge.allow_asf=0" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" if_lagg_load="YES" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" "kern.maxswzone=512M" >/dev/null
    ### vfs.zfs.arc_max limit arc usage on low RAM systems
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" "vfs.zfs.arc_max=256M" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" zfs_load="YES" >/dev/null
    ### network interfaces
    ifconfig -l | tr ' ' '\n' | awk '$1 !~ /lo[0-9]/ && $1 !~ /enc[0-9]/ && $1 !~ /fwe[0-9]/ && $1 !~ /fwip[0-9]/ && $1 !~ /gif[0-9]/ && $1 !~ /ipfw[0-9]/ && $1 !~ /pflog[0-9]/ && $1 !~ /plip[0-9]/ && $1 !~ /stf[0-9]/ && $1 !~ /lagg[0-9]/ {print $1}' | \
    while read line ; do
        grep          "ifconfig_${line}"          ${FZG_MNT}/etc/rc.conf.d/network >/dev/null 2>&1 \
            || echo "# ifconfig_${line}=\"up\"" >>${FZG_MNT}/etc/rc.conf.d/network
        grep          "ifconfig_${line}"          ${FZG_MNT}/etc/rc.conf.d/network >/dev/null 2>&1 \
            || echo "# ifconfig_${line}=\"up\"" >>${FZG_MNT}/etc/rc.conf.d/network
    done
    ### Set lagg as optional comments
    echo '### To enable Link Aggregation: BEGIN'                                >>${FZG_MNT}/etc/rc.conf.d/network
    nics=`ifconfig -l | tr ' ' '\n' | awk '$1 !~ /lo[0-9]/ && $1 !~ /enc[0-9]/ && $1 !~ /fwe[0-9]/ && $1 !~ /fwip[0-9]/ && $1 !~ /gif[0-9]/ && $1 !~ /ipfw[0-9]/ && $1 !~ /pflog[0-9]/ && $1 !~ /plip[0-9]/ && $1 !~ /stf[0-9]/ && $1 !~ /lagg[0-9]/ {print "laggport "$1}' | tr '\n' ' '`
    echo "# cloned_interfaces=\"lagg0\""                                        >>${FZG_MNT}/etc/rc.conf.d/network
    echo "# ifconfig_lagg0=\"DHCP laggproto loadbalance $nics\""                >>${FZG_MNT}/etc/rc.conf.d/network
    echo "# ifconfig_lagg0=\"inet 192.168.0.2/24 laggproto loadbalance $nics\"" >>${FZG_MNT}/etc/rc.conf.d/network
    echo '### To enable Link Aggregation: END'                                  >>${FZG_MNT}/etc/rc.conf.d/network
    ### optional set netwait_
    echo "# netwait_enable=\"YES\""                                             >>${FZG_MNT}/etc/rc.conf.d/netwait
    echo "# netwait_ip=\"`netstat -nr | grep default | awk '{print $2}'`\""     >>${FZG_MNT}/etc/rc.conf.d/netwait
    ### set defaultrouter
    echo "# defaultrouter=\"`netstat -nr | grep default | awk '{print $2}'`\""  >>${FZG_MNT}/etc/rc.conf.d/routing
}

freebsdconfiglocalmfsroot() {
    ### need this or zfs won't load
    sysrc -f "${FZG_MNT}/etc/rc.conf.local" zfs_enable="YES" >/dev/null
    ### mfs_ settings in loader.conf
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" mfs_load="YES" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" mfs_type="mfs_root" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" mfs_name="/$FZG_MFSROOT" >/dev/null
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" "vfs.root.mountfrom=ufs:/dev/md0" >/dev/null
    ### optional set packages to list we can pkg install -f -y ____
    echo "# packages=\"\""        >>${FZG_MNT}/boot/loader.conf.local
    ### optional set zpools to import
    echo "# zpool_import=\"\""    >>${FZG_MNT}/boot/loader.conf.local
    ### optional set mdinit_shell
    echo "# mdinit_shell=\"YES\"" >>${FZG_MNT}/boot/loader.conf.local
    ### set fzg_i_disks
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" fzg_i_disks="$ZFSBOOT_DISKS" >/dev/null
    ### set fzg_u_disks
    fzg_u_disks=""
    for i in $ZFSBOOT_DISKS; do
        fzg_u_disks="$fzg_u_disks ${i}p5"
    done
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" fzg_u_disks="$fzg_u_disks" >/dev/null
    ### set fzg_ilu_p_pool
    sysrc -f "${FZG_MNT}/boot/loader.conf.local" fzg_ilu_p_pool="tank" >/dev/null
}



### Function wrapper so we can toggle between using bsdinstall and custom
makepoolwith() {
    ### $1 is method
    if [ "$1" = "zfsboot" ]; then
        ### No ZFSBOOT_GNOP_4K_FORCE_ALIGN because if we use it,
        ### we can't add mirror later
        ZFSBOOT_DISKS="$ZFSBOOT_DISKS" \
        ZFSBOOT_VDEV_TYPE=$ZFSBOOT_VDEV_TYPE \
        ZFSBOOT_POOL_NAME=$ZFSBOOT_POOL_NAME \
        ZFSBOOT_POOL_SIZE=$ZFSBOOT_POOL_SIZE \
        ZFSBOOT_BEROOT_NAME=$ZFSBOOT_BEROOT_NAME \
        ZFSBOOT_BOOTFS_NAME=$ZFSBOOT_BOOTFS_NAME \
        ZFSBOOT_GELI_ENCRYPTION=1 \
        ZFSBOOT_BOOT_POOL_NAME=$ZFSBOOT_BOOT_POOL_NAME \
        ZFSBOOT_BOOT_POOL_SIZE=$ZFSBOOT_BOOT_POOL_SIZE \
        ZFSBOOT_SWAP_SIZE=$ZFSBOOT_SWAP_SIZE \
        ZFSBOOT_SWAP_ENCRYPTION=1 \
        ZFSBOOT_GELI_KEY_FILE=$ZFSBOOT_GELI_KEY_FILE \
        nonInteractive=0 \
        bsdinstall zfsboot || exiterror $?
    elif [ "$1" = "zfsinstall" ]; then
        ZFSBOOT_DATASETS="
        # DATASET       OPTIONS (comma or space separated; or both)

        # Boot Environment [BE] root and default boot dataset
        /$ZFSBOOT_BEROOT_NAME                           mountpoint=none
        /$ZFSBOOT_BEROOT_NAME/$ZFSBOOT_BOOTFS_NAME       mountpoint=/

        # Compress /tmp, allow exec but not setuid
        /tmp            mountpoint=/tmp,exec=on,setuid=off

        # Don't mount /usr so that 'base' files go to the BEROOT
        /usr            mountpoint=/usr,canmount=off

        # Home directories separated so they are common to all BEs
        /usr/home       # NB: /home is a symlink to /usr/home

        # Ports tree
        /usr/ports      setuid=off

        # Source tree (compressed)
        /usr/src

        # Create /var and friends
        /var            mountpoint=/var,canmount=off
        /var/crash      exec=off,setuid=off
        /var/log        exec=off,setuid=off
        /var/mail       atime=on
        /var/tmp        setuid=off
" # END-QUOTE
        ### Disk partitioning
        ### modified from https://github.com/mmatuska/mfsbsd
        install -d -m 700 ${FZG_BSDINSTALL_TMP}
        install -d -m 700 ${FZG_BSDINSTALL_ETC}
        umount ${FZG_BSDINSTALL_TMP} >/dev/null 2>&1
        mount -t tmpfs tmpfs ${FZG_BSDINSTALL_TMP}
        keyfiletmp=${FZG_BSDINSTALL_TMP}/encryption.key
        cachetmp=${FZG_BSDINSTALL_TMP}/zpool.cache
        cachereal=/boot/zfs/zpool.cache
        cacheoptions="-o cachefile=${cachetmp}"
        if [ ! -e ${keyfiletmp} ]; then
            umask 077
            dd if=/dev/random of=${keyfiletmp} bs=4096 count=1
            chmod go-rwx "${keyfiletmp}"
            umask $FZG_RESTORE_UMASK
        fi
        for DEV in $ZFSBOOT_DISKS ; do
            ### GPT create
            echo -n "Creating GUID partitions on $DEV ..."
            if ! gpart create -s GPT "/dev/$DEV" >/dev/null ; then
                echo " error at create"
                exiterror 1
            fi
            sync
            if ! echo "a 1" | fdisk -f - "$DEV" >/dev/null 2>&1 ; then
                echo " error at fdisk"
                exiterror 1
            fi
            ### freebsd-boot for bootcode
            if ! gpart add -t freebsd-boot $FZG_ALIGN4K -s 512K "$DEV" >/dev/null ; then
                echo " error at freebsd-boot"
                exiterror 1
            fi
            ### partition for /boot zpool
            if ! gpart add -t freebsd-zfs $FZG_ALIGN4K -s "${ZFSBOOT_BOOT_POOL_SIZE}b" "${DEV}" >/dev/null ; then
                echo " error at bpool"
                exiterror 1
            fi
            gptidboot=`glabel list ${DEV}${bootpart} | grep Name | head -1 | awk '{print $NF}'`
            dd if=/dev/zero of="/dev/label/$gptidboot" bs=512 count=560 >/dev/null 2>&1
            zpool labelclear -f "/dev/label/$gptidboot" >/dev/null 2>&1
            BPARTS="$BPARTS $gptidboot"
            ### partition for swap
            if [ -n "$ZFSBOOT_SWAP_SIZE" ]; then
                if ! gpart add -t freebsd-swap $FZG_ALIGN4K -s "${ZFSBOOT_SWAP_SIZE}b" "${DEV}" >/dev/null ; then
                    echo " error at swap"
                    exiterror 1
                fi
                gptidswap=`glabel list ${DEV}${swappart} | grep Name | head -1 | awk '{print $NF}'`
                dd if=/dev/zero of="/dev/label/$gptidswap" bs=512 count=560 >/dev/null 2>&1
                zpool labelclear -f "/dev/label/$gptidswap" >/dev/null 2>&1
                echo "/dev/$gptidswap.eli  none  swap  sw  0  0" >>${FZG_BSDINSTALL_ETC}/fstab
            fi
            ### partition for main root pool
            if [ -n "$ZFSBOOT_POOL_SIZE" ]; then
                ZSIZE="-s ${ZFSBOOT_POOL_SIZE}b"
            fi
            if ! gpart add -t freebsd-zfs $FZG_ALIGN4K $ZSIZE "${DEV}" >/dev/null ; then
                echo " error at zsize"
                exiterror 1
            fi
            gptidtarget=`glabel list ${DEV}${targetpart} | grep Name | head -1 | awk '{print $NF}'`
            safegptidtarget=`echo $gptidtarget | sed 's#/#_#'`
            dd if=/dev/zero of="/dev/label/$gptidtarget" bs=512 count=560 >/dev/null 2>&1
            zpool labelclear -f "/dev/label/$gptidtarget" >/dev/null 2>&1
            geli init -b -B "${FZG_BSDINSTALL_TMP}/${safegptidtarget}.eli" -P -K "$keyfiletmp" -e AES-XTS -l 256 -s 4096 "$gptidtarget"
            geli attach -p -k "$keyfiletmp" "$gptidtarget"
            TPARTS="$TPARTS $gptidtarget.eli"
            sysrc -f ${FZG_BSDINSTALL_TMP}/loader.conf.geli "geli_${safegptidtarget}_keyfile0_load=YES"
            sysrc -f ${FZG_BSDINSTALL_TMP}/loader.conf.geli "geli_${safegptidtarget}_keyfile0_type=${gptidtarget}:geli_keyfile0"
            sysrc -f ${FZG_BSDINSTALL_TMP}/loader.conf.geli "geli_${safegptidtarget}_keyfile0_name=${ZFSBOOT_GELI_KEY_FILE}"
            echo " done"
            ### Bootcode
            echo -n "Configuring ZFS bootcode on $DEV ..."
            if ! gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 "$DEV" >/dev/null ; then
                echo " error at bootcode"
                exiterror 1
            fi
            echo " done"
        done
        ### create main root pool
        [ "$ZFSBOOT_VDEV_TYPE" != "stripe" ] && TRAID=$ZFSBOOT_VDEV_TYPE
        echo -n "Creating ZFS pool $ZFSBOOT_POOL_NAME on $TPARTS ..."
        if ! zpool create -f -m none ${cacheoptions} -O compress=lz4 -O atime=off -R ${FZG_MNT} $ZFSBOOT_POOL_NAME $TRAID $TPARTS >/dev/null 2>&1 ; then
            echo " error"
            exiterror 1
        fi
        echo " done"
        ### create datasets
        echo -n "Creating ZFS datasets ..."
        echo "$ZFSBOOT_DATASETS" | while read dataset options; do
            case "$dataset" in "#"*|"") continue; esac
            options="${options%%#*}"
            oldoptions=
            while [ "$oldoptions" != "$options" ]; do
                oldoptions="$options"
                newoptions=`echo $options | sed 's/  / /g'`
                options="$newoptions"
            done
            newoptions=`echo $options | sed 's/[ ,]/ -o /g'`
            options="$newoptions"
            if ! zfs create ${options:+-o $options} "${ZFSBOOT_POOL_NAME}${dataset}" >/dev/null 2>&1 ; then
                echo " error"
                exiterror 1
            fi
            echo -n " $dataset"
        done
        echo " done"
        ### set bootfs, unsure if still needed
        echo -n "Setting bootfs for $ZFSBOOT_POOL_NAME to ${ZFSBOOT_POOL_NAME}/${ZFSBOOT_BEROOT_NAME}/${ZFSBOOT_BOOTFS_NAME} ..."
        if ! zpool set bootfs="${ZFSBOOT_POOL_NAME}/${ZFSBOOT_BEROOT_NAME}/${ZFSBOOT_BOOTFS_NAME}" "$ZFSBOOT_POOL_NAME" >/dev/null 2>&1 ; then
            echo " error"
            exiterror 1
        fi
        echo " done"
        ### create boot pool
        echo -n "Creating bootable ZFS pool $ZFSBOOT_BOOT_POOL_NAME on $BPARTS ..."
        count=$( echo "$ZFSBOOT_DISKS" | wc -w | awk '{ print $1 }' )
        [ "$count" -gt "1" ] && BRAID=mirror
        if ! zpool create -f ${cacheoptions} -R ${FZG_MNT} $ZFSBOOT_BOOT_POOL_NAME $BRAID $BPARTS >/dev/null 2>&1 ; then
            echo " error"
            exiterror 1
        fi
        echo " done"
        ### link boot pool
        install -d -m 755 ${FZG_MNT}/${ZFSBOOT_BOOT_POOL_NAME}/boot
        ln -sf ${ZFSBOOT_BOOT_POOL_NAME}/boot ${FZG_MNT}/boot
        ### copy header backups
        chmod 600 ${FZG_BSDINSTALL_TMP}/*.eli
        cp -a ${FZG_BSDINSTALL_TMP}/*.eli ${FZG_MNT}/boot/
        ### cachefile
        echo -n "Copying zpool.cache ..."
        sysrc -f ${FZG_BSDINSTALL_TMP}/loader.conf.zfs   zpool_cache_load="YES"
        sysrc -f ${FZG_BSDINSTALL_TMP}/loader.conf.zfs   zpool_cache_type="${cachereal}"
        sysrc -f ${FZG_BSDINSTALL_TMP}/loader.conf.zfs   zpool_cache_name="${cachereal}"
        if ! zpool export -f $ZFSBOOT_BOOT_POOL_NAME >/dev/null 2>&1 ; then
            echo " error exporting $ZFSBOOT_BOOT_POOL_NAME"
            exiterror 1
        fi
        if ! zpool export -f $ZFSBOOT_POOL_NAME >/dev/null 2>&1 ; then
            echo " error exporting $ZFSBOOT_POOL_NAME"
            exiterror 1
        fi
        if ! zpool import -f ${cacheoptions} -R ${FZG_MNT} $ZFSBOOT_POOL_NAME >/dev/null 2>&1 ; then
            echo " error importing $ZFSBOOT_POOL_NAME"
            exiterror 1
        fi
        if ! zpool import -f ${cacheoptions} -R ${FZG_MNT} $ZFSBOOT_BOOT_POOL_NAME >/dev/null 2>&1 ; then
            echo " error importing $ZFSBOOT_BOOT_POOL_NAME"
            exiterror 1
        fi
        install -d 755 ${FZG_MNT}/boot/zfs
        if ! cp ${cachetmp} "${FZG_MNT}${cachereal}" >/dev/null 2>&1 ; then
            echo " error copying zpool.cache"
            exiterror 1
        fi
        echo " done"
        ### keyfile
        echo -n "Copying keyfile ..."
        umask 077
        if ! install -m 600 -o root -g wheel ${keyfiletmp} "${FZG_MNT}${ZFSBOOT_GELI_KEY_FILE}" >/dev/null 2>&1 ; then
            echo " error copying keyfile"
            exiterror 1
        fi
        echo " done"
        chmod go-rwx "${FZG_MNT}${ZFSBOOT_GELI_KEY_FILE}"
        umask $FZG_RESTORE_UMASK
    fi
}

######################################################################
### End of functions
######################################################################



### Options parsing
### modified from https://github.com/mmatuska/mfsbsd
if [ $# -eq 0 ]; then
    usage ; exiterror 1
fi
while getopts b:d:e:p:r:s:M:z:cCiulxmfnvh o; do
    case "$o" in
        b) ZFSBOOT_BOOT_POOL_SIZE="$OPTARG" ;;
        d) ZFSBOOT_DISKS="$ZFSBOOT_DISKS ${OPTARG##/dev/}" ;;
        e) edisk="$OPTARG" ; ADDTOPOOL=1 ;;
        p) ZFSBOOT_POOL_NAME="$OPTARG" ; ZFSBOOT_BOOT_POOL_NAME="boot${ZFSBOOT_POOL_NAME}" ;;
        r) ZFSBOOT_VDEV_TYPE="$OPTARG" ;;
        s) ZFSBOOT_SWAP_SIZE="$OPTARG" ;;
        M) FZG_MNT="$OPTARG" ;;
        z) ZFSBOOT_POOL_SIZE="$OPTARG" ;;
        c) freebsdconfigglobal ; exit ;;
        C) freebsdconfigglobal ; freebsdconfiglocal ; exit ;;
        i) FZG_DATA_INIT=1 ; FZG_DATA_AUTO_SIZE=1 ;;
        u) FZG_DATA_UNLOCK=1 ;;
        l) FZG_DATA_LOCK=1 ;;
        x) unset FZG_DATA_AUTO_SIZE ;;
        m) FZG_MAKE_MFSROOT=1 ;;
        f) FZG_NEW_MFSROOT=1 ;;
        n) FZG_CHANGE_PASSWD=n ;;
        v) echo $SCRIPTVERSION ; exiterror 1 ;;
        h) usage ; exiterror 1 ;;
        [?]) usage ; exiterror 1 ;;
    esac
done
if [ "$FZG_DATA_INIT" -a "$FZG_DATA_LOCK" ]; then
    echo "Only pass -i or -l, not both."
    exiterror 1
elif [ "$FZG_DATA_LOCK" -a "$FZG_DATA_UNLOCK" ]; then
    echo "Only pass -l or -u, not both."
    exiterror 1
elif [ "$FZG_DATA_UNLOCK" -a "$FZG_DATA_INIT" ]; then
    echo "Only pass -u or -i, not both."
    exiterror 1
elif [ "$FZG_DATA_INIT" -a "$FZG_NEW_MFSROOT" ]; then
    echo "Only pass -i or -f, not both."
    exiterror 1
elif [ "$FZG_DATA_LOCK" -a "$FZG_NEW_MFSROOT" ]; then
    echo "Only pass -l or -f, not both."
    exiterror 1
elif [ "$FZG_DATA_UNLOCK" -a "$FZG_NEW_MFSROOT" ]; then
    echo "Only pass -u or -f, not both."
    exiterror 1
fi



### if not set, set ZFSBOOT_POOL_NAME and FZG_MNT
if [ "$FZG_DATA_INIT" -o "$FZG_DATA_LOCK" -o "$FZG_DATA_UNLOCK" ]; then
    if [ -n "`kenv -q fzg_ilu_p_pool`" ]; then
: ${ZFSBOOT_POOL_NAME:=`kenv -q fzg_ilu_p_pool`}
    else
: ${ZFSBOOT_POOL_NAME:=tank}
    fi
: ${FZG_MNT:=/z}
else
: ${ZFSBOOT_POOL_NAME:=pool}
: ${FZG_MNT:=/mnt}
fi



### if not set, set disks
if [ "$FZG_DATA_INIT" ]; then
: ${ZFSBOOT_DISKS:=`kenv -q fzg_i_disks`}
elif [ "$FZG_DATA_UNLOCK" ]; then
: ${ZFSBOOT_DISKS:=`kenv -q fzg_u_disks`}
fi



### backup mfsroot
mfspath=${FZG_MNT}/${ZFSBOOT_BOOT_POOL_NAME}/$FZG_MFSROOT
if [ "$FZG_NEW_MFSROOT" ]; then
    mfspath=/boot/../${FZG_MFSROOT}
    if [ -e ${mfspath} ]; then
        cp -a ${mfspath} ${mfspath}_old
    fi
fi



### set, partitions
bootpart=p2
swappart=p3
targetpart=p3
[ -n "$ZFSBOOT_SWAP_SIZE" ] && targetpart=p4



### Disk parsing for testing raid type
### modified from https://github.com/mmatuska/mfsbsd
if [ -z "$ADDTOPOOL" ] && [ -z "$FZG_DATA_UNLOCK" ] && [ -z "$FZG_NEW_MFSROOT" ]; then
    count=$( echo "$ZFSBOOT_DISKS" | wc -w | awk '{ print $1 }' )
    if [ "$count" -lt "3" -a "$ZFSBOOT_VDEV_TYPE" = "raidz" ]; then
        echo "ERROR: raidz needs at least three devices (-d switch)" ; exiterror 1
    elif [ "$count" -lt "4" -a "$ZFSBOOT_VDEV_TYPE" = "raidz2" ]; then
        echo "ERROR: raidz2 needs at least four devices (-d switch)" ; exiterror 1
    elif [ "$count" -lt "5" -a "$ZFSBOOT_VDEV_TYPE" = "raidz3" ]; then
        echo "ERROR: raidz3 needs at least five devices (-d switch)" ; exiterror 1
    elif [ "$count" = "1" -a "$ZFSBOOT_VDEV_TYPE" = "mirror" ]; then
        echo "ERROR: mirror needs at least two devices (-d switch)" ; exiterror 1
    elif [ "$count" = "2" -a "$ZFSBOOT_VDEV_TYPE" != "mirror" ]; then
        echo "NOTICE: two drives selected, automatically choosing mirror mode"
        ZFSBOOT_VDEV_TYPE="mirror"
    elif [ "$count" -gt "2" -a "$ZFSBOOT_VDEV_TYPE" != "mirror" -a "$ZFSBOOT_VDEV_TYPE" != "raidz" -a "$ZFSBOOT_VDEV_TYPE" != "raidz2" -a "$ZFSBOOT_VDEV_TYPE" != "raidz3" ]; then
        echo "ERROR: please choose raid mode with -r (mirror or raidz{1,2,3})"
        exiterror 1
    fi
fi



### Disk detect
### modified from https://github.com/mmatuska/mfsbsd
if [ "$FZG_DATA_INIT" -o "$FZG_DATA_LOCK" -o "$FZG_DATA_UNLOCK" -o "$FZG_NEW_MFSROOT" ]; then
    echo "NOTICE: Skipping device check."
else
    for DEV in $ZFSBOOT_DISKS ; do
        if [ ! -c "/dev/$DEV" ]; then
            echo "ERROR: /dev/$DEV is not a block device"
            exiterror 1
        fi
        if gpart show "$DEV" >/dev/null 2>&1 ; then
            echo "ERROR: /dev/$DEV already contains a partition table."
            exiterror 1
        fi
    done
fi



### Quit if pools exist, but if ADDTOPOOL, quit if not exist
if [ -z "$FZG_DATA_LOCK" -a -z "$FZG_DATA_UNLOCK" -a -z "$ADDTOPOOL" -a -z "$FZG_NEW_MFSROOT" ]; then
    if zpool status $ZFSBOOT_POOL_NAME >/dev/null 2>&1 ; then
        echo "ERROR: A pool named $ZFSBOOT_POOL_NAME already exists."
        exiterror 1
    fi
    if [ -z "$FZG_DATA_INIT" ]; then
        if zpool status $ZFSBOOT_BOOT_POOL_NAME >/dev/null 2>&1 ; then
            echo "ERROR: A pool named $ZFSBOOT_BOOT_POOL_NAME already exists."
            exiterror 1
        fi
    fi
elif [ "$ADDTOPOOL" -o "$FZG_DATA_LOCK" ]; then
    if ! zpool status $ZFSBOOT_POOL_NAME >/dev/null 2>&1 ; then
        echo "ERROR: A pool named $ZFSBOOT_POOL_NAME doesn't exists."
        exiterror 1
    fi
    if [ -z "$FZG_DATA_LOCK" ]; then
        if ! zpool status $ZFSBOOT_BOOT_POOL_NAME >/dev/null 2>&1 ; then
            echo "ERROR: A pool named $ZFSBOOT_BOOT_POOL_NAME doesn't exists."
            exiterror 1
        fi
    fi
fi



if [ "$FZG_DATA_INIT" ]; then
    ### FZG_DATA_INIT
    if [ "$FZG_DATA_AUTO_SIZE" ]; then
        echo -n "Creating data partitions ..."
        for disk in $ZFSBOOT_DISKS; do
            PARTCREATED=0
            for GSIZE in $FZG_DATA_SIZES ; do
                while [ "$PARTCREATED" = "0" ]; do
                    if [ "$PARTCREATED" != "1" ]; then
                        if /sbin/gpart add -i 5 -t freebsd-zfs $FZG_ALIGN4K -s ${GSIZE}G ${disk} >/dev/null 2>&1 ; then
                            echo " success adding partition sized ${GSIZE}G at $disk"
                            PARTCREATED=1
                            gptidtarget=`glabel list ${disk}p5 | grep Name | head -1 | awk '{print $NF}'`
                            dd if=/dev/zero of="/dev/$gptidtarget" bs=512 count=560 >/dev/null 2>&1
                            zpool labelclear -f "/dev/$gptidtarget" >/dev/null 2>&1
                            GPARTS="$GPARTS ${disk}p5"
                        else
                            ### we should actually use the next FZG_DATA_SIZES,
                            ### but for now we'll decrement by 1
                            GSIZE=$(( GSIZE - 1 ))
                        fi
                    fi
                    if [ $GSIZE -lt 1 ]; then
                        PARTCREATED=2
                        echo " error adding partition at $disk"
                    fi
                done
            done
            [ "$PARTCREATED" != "1" ] && exiterror 1
        done
        ZFSBOOT_DISKS="$GPARTS"
    fi
    if [ ! -e ${FZG_DATA_CRYPT_KEY} ]; then
        stty -echo
        printf "Data GELI Partition Key:"
        read PASSWORD
        stty echo
        printf "\n"
        echo -n "Encrypting Password, "
        umask 077
        echo $PASSWORD | openssl enc -aes-256-cbc -out ${FZG_DATA_CRYPT_KEY} -e -salt
        unset PASSWORD
        if [ -e ${FZG_MNT}/boot ]; then
            install -m 600 -o root -g wheel ${FZG_DATA_CRYPT_KEY} ${FZG_MNT}${FZG_DATA_CRYPT_KEY}
            chmod go-rwx ${FZG_MNT}${FZG_DATA_CRYPT_KEY}
        fi
        umask $FZG_RESTORE_UMASK
    fi
    cryptdecode
    if [ ! -e $TMPFILE ]; then
        echo "ERROR: Can't cryptdecode."
        exiterror 1
    fi
    echo -n "Initializing data partitions ..."
    for disk in $ZFSBOOT_DISKS; do
        echo -n " $disk"
        gptidtarget=`glabel list $disk | grep Name | head -1 | awk '{print $NF}'`
        safegptidtarget=`echo $gptidtarget | sed 's#/#_#'`
        if ! geli init -b -B /boot/${safegptidtarget}.eli -e AES-XTS -P -K $TMPFILE -l 256 -s 4096 ${gptidtarget} >/dev/null 2>&1 ; then
            echo " error"
            exiterror 1
        fi
        [ -e ${FZG_MNT}/boot ] && cp -a /boot/${safegptidtarget}.eli ${FZG_MNT}/boot/${safegptidtarget}.eli
        if ! geli attach -p -k $TMPFILE ${gptidtarget} >/dev/null 2>&1 ; then
            echo " error"
            exiterror 1
        fi
        vdevs="$vdevs ${gptidtarget}.eli"
    done
    rm $TMPFILE
    umount $FZG_TMP_CRYPT
    echo " done"
    if [ "$ADDTOPOOL" = "1" ]; then
        rpoolrealdisk=`zpool status $rpoolreal | grep -v state | grep ONLINE | tail -1 | awk '{print $1}'`
        echo -n "Attaching pool $ZFSBOOT_POOL_NAME ..."
        if ! zpool attach ${ZFSBOOT_POOL_NAME} ${rpoolrealdisk} ${vdevs} >/dev/null 2>&1 ; then
            echo " error"
            exiterror 1
        fi
        echo " done"
    else
        echo -n "Creating pool $ZFSBOOT_POOL_NAME ..."
        [ "$ZFSBOOT_VDEV_TYPE" != "stripe" ] && TRAID=$ZFSBOOT_VDEV_TYPE
        if ! zpool create -O compress=lz4 -O atime=off ${ZFSBOOT_POOL_NAME} ${TRAID} ${vdevs} >/dev/null 2>&1 ; then
            echo " error"
            exiterror 1
        fi
        echo " done"
    fi
elif [ "$FZG_DATA_LOCK" ]; then
    ### FZG_DATA_LOCK
    echo -n "Exporting pool ${ZFSBOOT_POOL_NAME} ..."
    ZFSBOOT_DISKS=`zpool status ${ZFSBOOT_POOL_NAME} | grep 'eli *ONLINE' | awk '{print $1}' | tr '\n' ' '`
    if ! zpool export -f ${ZFSBOOT_POOL_NAME} >/dev/null 2>&1 ; then
        echo " error"
        exiterror 1
    fi
    echo " done"
    sync
    echo -n "Detaching disks ..."
    for disk in $ZFSBOOT_DISKS; do
        if [ -e /dev/${disk} ]; then
            echo -n " $disk"
            if ! geli detach ${disk} >/dev/null 2>&1 ; then
                sleep 1
                if [ -e /dev/${disk} ]; then
                    echo " error"
                fi
            fi
        fi
    done
    echo " done"
elif [ "$FZG_DATA_UNLOCK" ]; then
    ### FZG_DATA_UNLOCK
    cryptdecode
    if [ ! -e $TMPFILE ]; then
        echo "ERROR: Can't cryptdecode."
        exiterror 1
    fi
    echo -n "Attaching disks ..."
    for disk in $ZFSBOOT_DISKS; do
        gptidtarget=`glabel list $disk | grep Name | head -1 | awk '{print $NF}'`
        safegptidtarget=`echo $gptidtarget | sed 's#/#_#'`
        if [ ! -e /dev/${gptidtarget}.eli ]; then
            echo -n " $disk"
            if ! geli attach -p -k $TMPFILE ${gptidtarget} >/dev/null 2>&1 ; then
                echo " error"
                exiterror 1
            fi
        fi
    done
    rm $TMPFILE
    umount $FZG_TMP_CRYPT
    echo " done"
    echo -n "Importing pool ${ZFSBOOT_POOL_NAME} ..."
    if ! zpool import ${ZFSBOOT_POOL_NAME} >/dev/null 2>&1 ; then
        echo " error"
        exiterror 1
    fi
    echo " done"
fi



### exit if DATA
if [ "$FZG_DATA_INIT" -o "$FZG_DATA_LOCK" -o "$FZG_DATA_UNLOCK" ]; then
    exiterror 0
fi



### Bootstrap pkgng early so user doesn't have to wait
if [ ! -f /usr/local/sbin/pkg-static ]; then
    pkg bootstrap
fi



### How to create a b64 patch
### diff -u zfsboot /usr/libexec/bsdinstall/zfsboot | xz | b64encode -
### Patch zfsboot for passwordless (-P,-p) geli
zfsbootpath=/usr/libexec/bsdinstall/zfsboot
chmod 755 $zfsbootpath
b64decode -o /dev/stdout <<EOF | xz -d | patch -N -l $zfsbootpath
begin-base64 644 -
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
====
EOF
chmod 555 $zfsbootpath



### load geli and remove past bsdinstall temporary files
geli load
rm -r /tmp/bsdinstall*



### Perform creation of zfsboot using zfsboot or zfsinstall
if [ -z "$FZG_NEW_MFSROOT" ]; then
    if [ "$ADDTOPOOL" = "1" ]; then
        bpoolreal=$ZFSBOOT_BOOT_POOL_NAME
        bpooltmp=tmpbpool
        ZFSBOOT_BOOT_POOL_NAME=$bpooltmp
        rpoolreal=$ZFSBOOT_POOL_NAME
        rpooltmp=tmprpool
        ZFSBOOT_POOL_NAME=$rpooltmp
    fi
    ### makepoolwith zfsboot or zfsinstall
    makepoolwith zfsinstall
    ### Do ADDTOPOOL stuff
    if [ "$ADDTOPOOL" = "1" ]; then
        ### get existing disk
        bpoolrealdisk=`zpool status $bpoolreal | grep -v state | grep ONLINE | tail -1 | awk '{print $1}'`
        rpoolrealdisk=`zpool status $rpoolreal | grep -v state | grep ONLINE | tail -1 | awk '{print $1}'`
        ### get new disk
        bpooltmpdisk=`zpool status $bpooltmp | grep -v state | grep ONLINE | tail -1 | awk '{print $1}'`
        rpooltmpdisk=`zpool status $rpooltmp | grep -v state | grep ONLINE | tail -1 | awk '{print $1}'`
        ### destroy pool
        zpool destroy -f $bpooltmp
        zpool destroy -f $rpooltmp
        ### attach bpool
        echo "Trying: zpool attach -f $bpoolreal $bpoolrealdisk $bpooltmpdisk"
        zpool attach -f $bpoolreal $bpoolrealdisk $bpooltmpdisk || exiterror 1
        ### attach rpool
        geli detach $rpooltmpdisk
        safefilename=` echo $rpooltmpdisk | sed 's#/#_#'`
        if [ -f /${bpoolreal}${ZFSBOOT_GELI_KEY_FILE} ]; then
            echo "Trying: geli init" ;   geli init   -b -B       "/${bpoolreal}/boot/${safefilename}" -e AES-XTS -P -K "/${bpoolreal}${ZFSBOOT_GELI_KEY_FILE}" -l 256 -s 4096 ${rpooltmpdisk%.eli} || exiterror 1
            echo "Trying: geli attach" ; geli attach -p -k       "/${bpoolreal}${ZFSBOOT_GELI_KEY_FILE}"                                                                      ${rpooltmpdisk%.eli} || exiterror 1
        elif [ -f ${FZG_MNT}/${bpoolreal}${ZFSBOOT_GELI_KEY_FILE} ]; then
            echo "Trying: geli init" ;   geli init   -b -B "${FZG_MNT}/${bpoolreal}/boot/${safefilename}" -e AES-XTS -P -K "${FZG_MNT}/${bpoolreal}${ZFSBOOT_GELI_KEY_FILE}" -l 256 -s 4096 ${rpooltmpdisk%.eli} || exiterror 1
            echo "Trying: geli attach" ; geli attach -p -k "${FZG_MNT}/${bpoolreal}${ZFSBOOT_GELI_KEY_FILE}"                                                                            ${rpooltmpdisk%.eli} || exiterror 1
        fi
        echo "Trying: zpool attach -f $rpoolreal $rpoolrealdisk $rpooltmpdisk"
        zpool attach -f $rpoolreal $rpoolrealdisk $rpooltmpdisk || exiterror $?
        cat <<EOF
Please wait for resilver to complete!
You can see the status of the process with:
    zpool status
EOF
    fi
    ### Copy the generated /boot/loader.conf and /etc/fstab
    if [ "$ADDTOPOOL" = "1" ]; then
        if [ ! -e ${FZG_MNT}/${bpoolreal}${ZFSBOOT_GELI_KEY_FILE} ]; then
            FZG_MNT=
        fi
    fi
    if [ "$ADDTOPOOL" = "1" -o "$FZG_MAKE_MFSROOT" ]; then
        cat ${FZG_BSDINSTALL_TMP}/loader.conf.* | grep -v vfs.root.mountfrom | grep -v aesni_load | grep -v geom_eli_load | grep -v zfs_load | grep -v kern.geom.label.gptid.enable >>${FZG_MNT}/boot/loader.conf.local
    else
        cat ${FZG_BSDINSTALL_TMP}/loader.conf.* |                              grep -v aesni_load | grep -v geom_eli_load | grep -v zfs_load | grep -v kern.geom.label.gptid.enable >>${FZG_MNT}/boot/loader.conf.local
    fi
    chmod 644 ${FZG_MNT}/boot/loader.conf.local
    umount ${FZG_BSDINSTALL_TMP} >/dev/null 2>&1
    if [ -e ${FZG_BSDINSTALL_ETC}/fstab ]; then
        cat ${FZG_BSDINSTALL_ETC}/fstab >>${FZG_MNT}/boot/fstab.append
        chmod 644 ${FZG_MNT}/boot/fstab.append
    fi
    if [ "$ADDTOPOOL" = "1" ]; then
        exit
    fi
fi # end of if [ -z "$FZG_NEW_MFSROOT" ]; then



### Check if local distribution exists, if so copy to FZG_MNT
### this notation /boot/.. is in case /boot is a symlink (eg. mfsroot)
BSDINSTALL_DISTDIR=/boot/../${FZG_RELEASE}
if [ -z "$FZG_NEW_MFSROOT" ]; then
    if [ ! -e $BSDINSTALL_DISTDIR/kernel.txz -o ! -e $BSDINSTALL_DISTDIR/base.txz ]; then
        BSDINSTALL_DISTDIR=${FZG_MNT}/boot/../${FZG_RELEASE}
    else
        echo -n "Copying $BSDINSTALL_DISTDIR to ${FZG_MNT}/boot/../${FZG_RELEASE}"
        install -d -m 755 ${FZG_MNT}/boot/../${FZG_RELEASE}
        tar -c -f - -C /boot/.. ${FZG_RELEASE} | tar -C ${FZG_MNT}/boot/.. -x -f - || exiterror 1
        echo " done"
    fi
fi # end of if [ -z "$FZG_NEW_MFSROOT" ]; then
install -d -m 755 $BSDINSTALL_DISTDIR



if [ ! -e $BSDINSTALL_DISTDIR/kernel.txz -o ! -e $BSDINSTALL_DISTDIR/base.txz ]; then
    ### Fetch distribution if no local copy exists
    DISTRIBUTIONS="kernel.txz base.txz lib32.txz" \
    BSDINSTALL_DISTDIR=$BSDINSTALL_DISTDIR \
    BSDINSTALL_DISTSITE="$BSDINSTALL_DISTSITE_BASE/`uname -m`/`uname -p`/${FZG_RELEASE}" \
    nonInteractive=0 \
    bsdinstall distfetch || exiterror $?
fi



if [ "$FZG_NEW_MFSROOT" ]; then
    ### Create upgrade if $FZG_NEW_MFSROOT
    zfs destroy ${ZFSBOOT_POOL_NAME}/upgrade >/dev/null 2>&1
    zfs create -o mountpoint=${FZG_MNT} ${ZFSBOOT_POOL_NAME}/upgrade
fi

### Create some extra datasets if mfsroot
### modified from /usr/libexec/bsdinstall/zfsboot
MFS_DATASETS="
/etc            mountpoint=/etc,canmount=off
/etc/mail       exec=off,setuid=off
/etc/pf         exec=off,setuid=off
/etc/rc.conf.d  exec=off,setuid=off
/etc/ssh        exec=off,setuid=off

/root           mountpoint=/root,canmount=off
/root/.ssh      exec=off,setuid=off
/root/bin       setuid=off

/usr/local

/var/at         exec=off,setuid=off
/var/audit
/var/backups    exec=off,setuid=off
/var/cache      exec=off,setuid=off
/var/cron       exec=off,setuid=off
/var/db         exec=off,setuid=off
/var/run
/var/spool      exec=off,setuid=off
" # END-QUOTE

if [ "$FZG_MAKE_MFSROOT" -a -z "$FZG_NEW_MFSROOT" ]; then
    ### create datasets
    echo -n "Creating ZFS datasets for MFS setup ..."
    echo "$MFS_DATASETS" | while read dataset options; do
        case "$dataset" in "#"*|"") continue; esac
        options="${options%%#*}"
        oldoptions=
        while [ "$oldoptions" != "$options" ]; do
            oldoptions="$options"
            newoptions=`echo $options | sed 's/  / /g'`
            options="$newoptions"
        done
        newoptions=`echo $options | sed 's/[ ,]/ -o /g'`
        options="$newoptions"
        if ! zfs create ${options:+-o $options} "${ZFSBOOT_POOL_NAME}${dataset}" >/dev/null 2>&1 ; then
            echo " error"
            exiterror 1
        fi
        echo -n " $dataset"
    done
    echo " done"
elif [ "$FZG_NEW_MFSROOT" ]; then
    ORIGINAL_SET="
    /${ZFSBOOT_BOOT_POOL_NAME}
    /tmp
    /usr
    /var/crash
    /var/log
    /var/mail
    /var/tmp
" ### end of ORIGINAL_SET
    ### create datasets
    echo -n "Creating TMPFS for MFS setup ..."
    echo "$ORIGINAL_SET" | while read dataset options; do
        case "$dataset" in "#"*|"") continue; esac
        install -d -m 755 "${FZG_MNT}${dataset}"
        if ! mount -t tmpfs tmpfs "${FZG_MNT}${dataset}" >/dev/null 2>&1 ; then
            echo " error"
            exiterror 1
        fi
        echo -n " $dataset"
    done
    install -d -m 755 ${FZG_MNT}/${ZFSBOOT_BOOT_POOL_NAME}/boot
    ln -sf ${ZFSBOOT_BOOT_POOL_NAME}/boot ${FZG_MNT}/boot
    echo "$MFS_DATASETS" | while read dataset options; do
        case "$dataset" in "#"*|"") continue; esac
        if ! echo "$options" | grep "canmount=off" >/dev/null 2>&1 ; then
            install -d -m 755 "${FZG_MNT}${dataset}"
            if ! mount -t tmpfs tmpfs "${FZG_MNT}${dataset}" >/dev/null 2>&1 ; then
                echo " error"
                exiterror 1
            fi
            echo -n " $dataset"
        fi
    done
    echo " done"
fi



### permissions
chmod 700 ${FZG_MNT}/root/.ssh
chmod 700 ${FZG_MNT}/root/bin
install -d -m 750 -o root       -g audit ${FZG_MNT}/var/audit
install -d -m 770 -o auditdistd -g audit ${FZG_MNT}/var/audit/dist
install -d -m 700 -o auditdistd -g wheel ${FZG_MNT}/var/audit/remote
chmod 750 ${FZG_MNT}/var/audit
chmod 770 ${FZG_MNT}/var/audit/dist
chmod 700 ${FZG_MNT}/var/audit/remote
chown root:audit       ${FZG_MNT}/var/audit
chown auditdistd:audit ${FZG_MNT}/var/audit/dist
chown auditdistd:wheel ${FZG_MNT}/var/audit/remote



### Extract ditribution
DISTRIBUTIONS="kernel.txz base.txz" \
BSDINSTALL_DISTDIR=$BSDINSTALL_DISTDIR \
BSDINSTALL_CHROOT=$FZG_MNT \
nonInteractive=0 \
bsdinstall distextract || exiterror $?



if [ "$FZG_NEW_MFSROOT" -o -z "$FZG_NEW_MFSROOT" ]; then
    ### Allow for update using freebsd-update
    echo "nameserver 8.8.8.8" >${FZG_MNT}/etc/resolv.conf
    echo "Running: chroot ${FZG_MNT} freebsd-update fetch"
    chroot ${FZG_MNT} freebsd-update fetch | cat >/tmp/fuf.log
    if ! cat /tmp/fuf.log | grep 'No updates needed to update system' >/dev/null 2>&1 ; then
        cat /tmp/fuf.log
        echo "Running: chroot ${FZG_MNT} freebsd-update install"
        chroot ${FZG_MNT} freebsd-update install | cat >/tmp/fui.log
        if ! cat /tmp/fui.log | grep 'Installing....*done' >/dev/null 2>&1 ; then
            cat /tmp/fui.log
            cat <<EOF
Please connect another session and check that the system updated successfully:
    chroot $FZG_MNT freebsd-update fetch
    chroot $FZG_MNT freebsd-update install
EOF
            echo -n "Then here, press ENTER to continue "
            read CONTINUENOW
        fi
    fi
    rm ${FZG_MNT}/etc/resolv.conf
fi ### end of if [ "$FZG_NEW_MFSROOT" -o -z "$FZG_NEW_MFSROOT" ]; then



if [ -f /usr/local/sbin/pkg-static ]; then
    ### Copy pkg-static
    install -m 700 -o root -g wheel /usr/local/sbin/pkg-static ${FZG_MNT}/sbin/pkg-static
fi



if [ -z "$FZG_NEW_MFSROOT" ]; then
    ### Fetch some packages we can cache in /boot/packages
    install -d -m 755 ${FZG_MNT}/boot/packages
    if [ -d /boot/packages ]; then
        echo "Copying /boot/packages to ${FZG_MNT}/boot/packages"
        tar -c -f - -C /boot/ packages | tar -C ${FZG_MNT}/boot/ -x -f - || exiterror $?
    else
        if [ -f /usr/local/etc/pkg.conf ]; then
            cat /usr/local/etc/pkg.conf >/usr/local/etc/pkg.conf.bkp
        fi
        install -d -m 755 /usr/local/etc
        echo "PKG_CACHEDIR = \"${FZG_MNT}/boot/packages\";" >>/usr/local/etc/pkg.conf
        if [ -e $HOME/.cshpkglist ]; then
            PKGLIST="`cat $HOME/.cshpkglist | grep -v '^#' | tr ' ' '\n' | grep -v '^\$'`"
        else
            PKGLIST="
            cmdwatch
            ezjail
            git expat p5-Authen-SASL p5-GSSAPI perl5 p5-Digest-HMAC
                p5-Net-SMTP-SSL p5-IO-Socket-SSL p5-Mozilla-CA p5-Net-SSLeay
                p5-Socket p5-IO-Socket-IP python27 libffi indexinfo gettext-runtime
                p5-Error curl ca_root_nss cvsps p5-MIME-Base64
            gnupg1 indexinfo curl ca_root_nss gettext-runtime
            iftop
            nginx pcre
            openntpd
            openssl
            pkg
            rsync
            tmux libevent2
            ucarp
            wget indexinfo libidn gettext-runtime
" ### end of PKGLIST
        fi
        ### Don't exiterror, because pkg-static segfault
        pkg-static fetch -y $PKGLIST
        if [ -f /usr/local/etc/pkg.conf.bkp ]; then
            cat /usr/local/etc/pkg.conf.bkp >/usr/local/etc/pkg.conf
            rm /usr/local/etc/pkg.conf.bkp
        else
            rm /usr/local/etc/pkg.conf
        fi
    fi
fi ### end of if [ -z "$FZG_NEW_MFSROOT" ]; then



### Set config
freebsdconfigglobal
freebsdconfiglocal



### Set ifconfig DHCP
ifconfig -l | tr ' ' '\n' | awk '$1 !~ /lo[0-9]/ && $1 !~ /enc[0-9]/ && $1 !~ /fwe[0-9]/ && $1 !~ /fwip[0-9]/ && $1 !~ /gif[0-9]/ && $1 !~ /ipfw[0-9]/ && $1 !~ /pflog[0-9]/ && $1 !~ /plip[0-9]/ &&  $1 !~ /stf[0-9]/ && $1 !~ /lagg[0-9]/ {print $1}' | \
while read line ; do
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/network" ifconfig_${line}="DHCP"
done



### Change password of new system to blank
yes '' | chroot $FZG_MNT passwd



### Add urep user
chroot $FZG_MNT sh -c 'echo "urep:1001::::::/usr/home/urep:/bin/csh:" | adduser -w no -f -'



append_motd $FZG_MNT



if [ "$FZG_MAKE_MFSROOT" -o "$FZG_NEW_MFSROOT" ]; then
    ### Actually make the MFSROOT
    echo "Creating mfsroot container at ${mfspath} with dd"
    dd if=/dev/zero of=${mfspath} bs=512 count=245760 || exiterror $?
    mdevice=`mdconfig -a -t vnode -f ${mfspath}`
    install -d -m 755 $FZG_MFS_MNT
    echo "Making new fs on /dev/${mdevice}"
    newfs /dev/${mdevice} || exiterror $?
    echo "Mouting /dev/${mdevice} to $FZG_MFS_MNT"
    mount /dev/${mdevice} $FZG_MFS_MNT || exiterror $?
    ### Copy everything except /usr
    echo "Copying ${FZG_MNT} to $FZG_MFS_MNT"
    tar -c -f - \
        --exclude ./$ZFSBOOT_BOOT_POOL_NAME \
        --exclude ./${FZG_RELEASE} \
        --exclude ./etc/mail \
        --exclude ./etc/pf \
        --exclude ./etc/rc.conf.d \
        --exclude ./etc/ssh \
        --exclude ./usr \
        --exclude ./var/at \
        --exclude ./var/backups \
        --exclude ./var/cache \
        --exclude ./var/crash \
        --exclude ./var/cron \
        --exclude ./var/db \
        --exclude ./var/log \
        --exclude ./var/mail \
        --exclude ./var/run \
        --exclude ./var/spool \
        --exclude ./var/tmp \
        -C ${FZG_MNT} ./ | tar -C $FZG_MFS_MNT -x -f - || exiterror $?
    ### rc script for tmpfs /usr
    ### modified from https://github.com/mmatuska/mfsbsd
    cat >$FZG_MFS_MNT/etc/rc.d/mdinit <<EOF
#!/bin/sh
# \$Id\$
# PROVIDE: mdinit
# BEFORE: zfs FILESYSTEMS
# REQUIRE: mountcritlocal
# KEYWORD: FreeBSD
. /etc/rc.subr
name="mdinit"
start_cmd="mdinit_start"
stop_cmd=":"
mdinit_start()
{
  if [ -f /.usr.tar.xz ]; then
    /rescue/test -d /usr || /rescue/mkdir /usr
    /rescue/test -d /usr && /rescue/mount -t tmpfs tmpfs /usr
    /rescue/test -d /usr && /rescue/tar -x -C / -f /.usr.tar.xz
  elif [ -f /.usr.tar.bz2 ]; then
    /rescue/test -d /usr || /rescue/mkdir /usr
    /rescue/test -d /usr && /rescue/mount -t tmpfs tmpfs /usr
    /rescue/test -d /usr && /rescue/tar -x -C / -f /.usr.tar.bz2
  elif [ -f /.usr.tar.gz ]; then
    /rescue/test -d /usr || /rescue/mkdir /usr
    /rescue/test -d /usr && /rescue/mount -t tmpfs tmpfs /usr
    /rescue/test -d /usr && /rescue/tar -x -C / -f /.usr.tar.gz
  fi
  if [ ! -f /usr/bin/which ]; then
    echo "ERROR: in mdinit while extracting /usr, entering shell:"
    /rescue/sh
  fi
  if zfs list -H -o name,canmount,mountpoint | awk '\$2 ~ /on/ {print}' | grep 'on[^/]*/\$' ; then
    echo "Disabling some zfs datasets that mount to /"
    DATASETS=\$(zfs list -H -o name,canmount,mountpoint | awk '\$2 ~ /on/ {print}' | grep 'on[^/]*/\$' | awk '{print \$1}')
    for Z in \$DATASETS ; do
      echo zfs set canmount=off \$Z
      zfs set canmount=off \$Z
    done
  fi
  if /bin/kenv -q mdinit_shell | grep YES ; then
    echo "Found mdinit_shell, entering shell:"
    /rescue/sh
  fi
}
load_rc_config \$name
run_rc_command "\$1"
EOF
    chmod 555 $FZG_MFS_MNT/etc/rc.d/mdinit
    ### zpoolimport because we are in mfs and harder to persist
    cat >$FZG_MFS_MNT/etc/rc.d/zpoolimport <<EOF
#!/bin/sh
# \$Id\$
# PROVIDE: zpoolimport
# BEFORE: hostname netif
# REQUIRE: mdinit FILESYSTEMS
# KEYWORD: FreeBSD
. /etc/rc.subr
name="zpoolimport"
start_cmd="zpoolimport_start"
stop_cmd=":"
zpoolimport_start()
{
    ### import before trying /boot/*
    if /bin/kenv -q zpool_import 2>/dev/null ; then
        for i in \$( /bin/kenv -q zpool_import ) ; do
            /sbin/zpool import -f "\$i"
        done
    fi
    for f in fstab hosts periodic.conf resolv.conf sysctl.conf ; do
        suffix=.overwrite
        if [ -e /boot/\${f}\${suffix} ]; then
            cat /boot/\${f}\${suffix} >/etc/\${f}
        fi
        suffix=.append
        if [ -e /boot/\${f}\${suffix} ]; then
            cat /boot/\${f}\${suffix} >>/etc/\${f}
        fi
    done
    service sysctl start
}
load_rc_config \$name
run_rc_command "\$1"
EOF
    chmod 555 $FZG_MFS_MNT/etc/rc.d/zpoolimport
    ### packages because we are in mfs and harder to persist
    cat >$FZG_MFS_MNT/etc/rc.d/packages <<EOF
#!/bin/sh
# \$Id\$
# PROVIDE: packages
# REQUIRE: FILESYSTEMS NETWORKING SERVERS DAEMON LOGIN dhclient
# KEYWORD: FreeBSD
. /etc/rc.subr
name="packages"
start_cmd="packages_start"
stop_cmd=":"
do_p_install()
{
    for P in \$( /bin/kenv -q packages ) ; do
        echo -n "Installing \$P..."
        ### force pkg to re-add to create user/groups
        pkg-static install -f -y \$P >/var/log/packages.net.log 2>&1
        echo "done"
      done
    service ezjail start
    if ls /boot/packages/*.t?z >/dev/null 2>&1 ; then
        ### force pkg to re-add to create user/groups
        pkg-static add -f \$( ls /boot/packages/*.t?z ) >/var/log/packages.local.log 2>&1
        service openntpd restart
    fi
}
packages_start()
{
    do_p_install &
}
load_rc_config \$name
run_rc_command "\$1"
EOF
    chmod 555 $FZG_MFS_MNT/etc/rc.d/packages
    ### Package /usr
    echo "Compressing ${FZG_MNT}/usr to $FZG_MFS_MNT/.usr.tar.xz"
    tar -c -J -f $FZG_MFS_MNT/.usr.tar.xz --exclude ${FZG_RELEASE} --options xz:compression-level=9 -C ${FZG_MNT} usr || exiterror $?
    ### if .csh*
    for i in /root/.csh* ; do
        echo -n "Copying ${i} to ${FZG_MFS_MNT}/root/ ..."
        install -m 644 ${i} ${FZG_MFS_MNT}/root/
        echo " done"
    done
    ### Unmount
    echo "Unmounting /dev/${mdevice}"
    umount /dev/${mdevice} || exiterror $?
    mdconfig -d -u ${mdevice#md} || exiterror $?
    freebsdconfiglocalmfsroot
fi ### end of if [ "$FZG_MAKE_MFSROOT" -o "$FZG_NEW_MFSROOT" ]; then



if [ "$FZG_NEW_MFSROOT" ]; then
    ### Destroy upgrade if $FZG_NEW_MFSROOT
    for k in 1 2 ; do
        for i in `mount | grep "tmpfs" | grep $FZG_MNT | awk '{print $3}'` ; do
            umount $i >/dev/null 2>&1
        done
    done
    zfs destroy ${ZFSBOOT_POOL_NAME}/upgrade
fi



if [ -z "$FZG_NEW_MFSROOT" ]; then
    ### If .ssh/authorized_keys exists, copy that
    if [ -e /root/.ssh/authorized_keys ]; then
        echo -n "Copying authorized_keys to ${FZG_MNT}/root/.ssh/authorized_keys ..."
        cp /root/.ssh/authorized_keys ${FZG_MNT}/root/.ssh/authorized_keys
        chmod 600 ${FZG_MNT}/root/.ssh/authorized_keys
        echo " done"
    fi
    ### If fzg exists, copy that
    if ls /root/bin | grep . >/dev/null 2>&1 ; then
        echo -n "Copying bin/* to ${FZG_MNT}/root/bin/ ..."
        chmod 700 /root/bin
        install -d -m 700 ${FZG_MNT}/root/bin
        tar -c -f - -C /root bin | tar -C ${FZG_MNT}/root -x -f - || exiterror 1
        chmod 700 ${FZG_MNT}/root/bin/*
        echo " done"
    fi
    ### If files exists, copy that
    for f in fstab hosts periodic.conf resolv.conf sysctl.conf ; do
        for suffix in .overwrite .append ; do
            if [ -e /boot/${f}${suffix} ] && [ ! -e ${FZG_MNT}/boot/${f}${suffix} ] ; then
                echo -n "Copying ${f}${suffix} to ${FZG_MNT}/boot/${f}${suffix} ..."
                cp /boot/${f}${suffix} ${FZG_MNT}/boot/${f}${suffix}
                chmod 600 ${FZG_MNT}/boot/${f}${suffix}
                echo " done"
            fi
        done
    done
fi ### end of if [ -z "$FZG_NEW_MFSROOT" ]; then



while [ "$FZG_CHANGE_PASSWD" = "y" -o "$FZG_CHANGE_PASSWD" = "Y" ]; do
    ### Prompt to change root password of new install
    echo -n "Change root password of new installation? [y/N] "
    read FZG_CHANGE_PASSWD
    case $FZG_CHANGE_PASSWD in
        y|Y)
            if [ "$FZG_MAKE_MFSROOT" -o "$FZG_NEW_MFSROOT" ]; then
                mdevice=`mdconfig -a -t vnode -f ${mfspath}`
                mount /dev/${mdevice} $FZG_MFS_MNT
                mount -t devfs devfs $FZG_MFS_MNT/dev
                chroot $FZG_MFS_MNT /etc/rc.d/mdinit start
                chroot $FZG_MFS_MNT passwd
                umount $FZG_MFS_MNT/dev
                umount $FZG_MFS_MNT/usr
                umount /dev/${mdevice}
                mdconfig -d -u ${mdevice#md}
            else
                chroot $FZG_MNT passwd
            fi
        ;;
    esac
done



if [ -z "$FZG_NEW_MFSROOT" ]; then
    ### Remind not to export pool
    cat <<EOF
Don't export the ZFS pools!

You may want to set the hostname with:
    sysrc -f "${FZG_MNT}/etc/rc.conf.d/hostname" hostname="name"
See file ${FZG_MNT}/boot/loader.conf.local for more options.
EOF
fi ### end of if [ -z "$FZG_NEW_MFSROOT" ]; then
