#!/bin/sh

. /usr/local/bin/loadmyvars.sh

. /usr/local/bin/keypkg-functions


































if [ "x" = "x$KGT_KEY_POOL_NAME" ]; then
    KGT_KEY_POOL_NAME="key"
fi










ENCPASSFILE=${KGT_TMPFS}/keypkg_$(hostname -s).smime

create_etckeypkg

create_encpassfile







if [ -e $ENCPASSFILE ]; then
    echo "You can now upload this file: $ENCPASSFILE"
    ls -l $ENCPASSFILE
fi



configure_keypkg

cat <<EOF
Add the /etc/keypkg/id_rsa.pub to the server as user `hostname -s`/.ssh/authorized_keys2:
keypkg-auth `hostname -s`

Edit the keypkg_ssh with: vi /etc/rc.conf.d/keypkg
Edit the Hostname with:   vi /etc/keypkg/ssh_config

Then upload the key to the server:
cat $ENCPASSFILE | ssh -F /etc/keypkg/ssh_config -l$(hostname -s) one keypkg put

Then proceed to part2:
keypkg-part2 -t 4 -p tank -r mirror -d ada0 -d ada1 -d ada2
EOF
